<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Backend Upload Test</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      max-width: 800px;
      margin: 0 auto;
    }

    .box {
      border: 2px solid #ddd;
      padding: 20px;
      border-radius: 8px;
      margin-top: 20px;
    }

    pre {
      background: #f4f4f4;
      padding: 15px;
      overflow-x: auto;
      border-radius: 4px;
    }

    .error {
      color: red;
      font-weight: bold;
    }

    .success {
      color: green;
      font-weight: bold;
    }

    button {
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
    }

    button:hover {
      background: #0056b3;
    }
  </style>
</head>

<body>

  <h2>üõ†Ô∏è Backend Connection Test</h2>
  <p>This script sends the file + the required missing fields (title, room_slug, tags).</p>

  <div class="box">
    <label><strong>Select PDF:</strong></label><br><br>
    <input type="file" id="fileInput">
    <br><br>
    <button id="uploadBtn" type="button">üöÄ Upload & Test</button>
  </div>

  <div class="box">
    <h3>Status:</h3>
    <p id="status">Waiting for input...</p>

    <h3>Server Response:</h3>
    <pre id="output">No data yet.</pre>
  </div>

  <script>
    // ==========================================
    // 1. PASTE YOUR TOKEN HERE
    // ==========================================
    const TOKEN = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOjgsImVtYWlsIjoiam95QGdtYWlsLmNvbSIsInJvbGUiOiJzdHVkZW50IiwiaWF0IjoxNzY3NjM0ODgwLCJleHAiOjE3Njc2Mzg0ODB9.r8AW1IrUMw5VWjKJ9SYTGFjcqa7VVjQsPoCdTDmKzTs";

    // Backend URL (Make sure this matches your running server)
    const BACKEND_URL = "http://127.0.0.1:8000";

    document.getElementById('uploadBtn').addEventListener('click', async () => {
      const fileInput = document.getElementById('fileInput');
      const status = document.getElementById('status');
      const output = document.getElementById('output');

      // clear previous logs
      status.className = "";
      output.textContent = "Processing...";

      if (fileInput.files.length === 0) {
        alert("Please select a file first!");
        return;
      }

      status.textContent = "‚è≥ Uploading... (This may take 30s for AI)";

      // 2. Prepare Data (Fixing the 422 Error)
      const formData = new FormData();
      formData.append("file", fileInput.files[0]);

      // --- THESE WERE MISSING BEFORE ---
      formData.append("title", "Test Upload Document");
      formData.append("room_slug", "cs");
      formData.append("tags", "test_tag");
      // --------------------------------

      try {
        // 3. Send Request
        const response = await fetch(`${BACKEND_URL}/student/upload`, {
          method: "POST",
          headers: {
            // CRITICAL: Do NOT add 'Content-Type': 'multipart/form-data'
            // The browser adds it automatically.
            "Authorization": `Bearer ${TOKEN}`
          },
          body: formData
        });

        // 4. Handle Response
        if (!response.ok) {
          const errText = await response.text();
          throw new Error(`Server Error: ${response.status} \nDetails: ${errText}`);
        }

        const data = await response.json();

        // 5. Success Display
        status.textContent = "‚úÖ SUCCESS! Backend accepted the file.";
        status.className = "success";
        output.textContent = JSON.stringify(data, null, 2);

      } catch (error) {
        // 6. Error Display
        console.error(error);
        status.textContent = "‚ùå FAILED";
        status.className = "error";
        output.textContent = error.message;
      }
    });
  </script>

</body>

</html>